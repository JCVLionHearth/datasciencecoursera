Gracias por el ejemplo, el problema estÃ¡ en cÃ³mo estÃ¡s creando el grupo nombre_base con word(MCOD_1, 1, 3). Esa funciÃ³n simplemente toma las tres primeras palabras de la cadena sin limpiar caracteres especiales, por lo que nombres como:
	â€¢	"TRAFIGURAÂ ENVIRONMENTALÂ S"
	â€¢	"TRAFIGURAÂ MARKETINGÂ COLOM"

no quedan agrupados como "TRAFIGURA".

â¸»

âœ… SoluciÃ³n: Normaliza los nombres para agrupar por raÃ­z comÃºn

Podemos hacer lo siguiente:
	1.	Limpiar espacios y tildes.
	2.	Extraer un identificador base del nombre (como â€œTRAFIGURAâ€).
	3.	Agrupar por ese identificador y aplicar la moda condicionada.

â¸»

âœ… CÃ³digo corregido:

library(dplyr)
library(stringr)

# FunciÃ³n para obtener la moda con mayorÃ­a
moda_con_mayoria <- function(x, umbral = 0.05) {
  x <- na.omit(x)
  if (length(x) == 0) return(NA)
  tab <- table(x)
  moda <- names(tab)[which.max(tab)]
  prop <- max(tab) / sum(tab)
  if (prop >= umbral) return(moda) else return(NA)
}

# Limpiar y extraer nombre base (por ejemplo, "TRAFIGURA")
proveedores_ciiu_imputado2 <- proveedores_ciiu_imputado %>%
  mutate(
    MCOD_clean = str_squish(str_to_upper(MCOD_1)),
    nombre_base = str_extract(MCOD_clean, "^[A-Z]+")  # Extrae solo la primera palabra
  ) %>%
  group_by(nombre_base) %>%
  mutate(
    moda_valor = moda_con_mayoria(CIIU_final, umbral = 0.05),
    CIIU_final = if_else(is.na(CIIU_final), moda_valor, CIIU_final)
  ) %>%
  ungroup() %>%
  select(-MCOD_clean, -nombre_base, -moda_valor)


â¸»

ğŸ” QuÃ© hace este cÃ³digo:
	â€¢	str_squish() elimina espacios dobles.
	â€¢	str_to_upper() estandariza mayÃºsculas.
	â€¢	str_extract(..., "^[A-Z]+") captura la primera palabra (marca principal).
	â€¢	Agrupa por esa base comÃºn (por ejemplo "TRAFIGURA").
	â€¢	Imputa el cÃ³digo CIIU mÃ¡s frecuente si al menos el 5% lo usa (umbral = 0.05).

â¸»

ğŸ§ª Resultado esperado con tus datos de ejemplo:

MCOD_1	ANTES	CIIU_final
TRAFIGURAÂ ENVIRONMENTALÂ S	NA	4661
TRAFIGURAÂ TRADINGÂ LLC	4669	4669
TRAFIGURAÂ SECURITISATION	NA	4661
TRAFIGURAÂ MARITIMEÂ LOGIST	6412	6412
TRAFIGURAÂ PTEÂ LTD	4290	4290
C.I.Â TRAFIGURAÂ PETROLEUM	4661	4661
TRAFIGURAÂ ENERGYÂ COLOMBIA	4661	4661
TRAFIGURAÂ MARKETINGÂ COLOM	4661	4661


â¸»

Â¿Quieres que ademÃ¡s le dÃ© prioridad a los cÃ³digos CIIU de longitud 4 dÃ­gitos o que solo tome esos para la moda? TambiÃ©n es posible.



Estoy intentando imputar por similitud de nombre el cÃ³digo CIIU por medio del siguiente cÃ³digo en R

## imputacion por nombre

library(dplyr)

# FunciÃ³n para obtener la moda solo si representa mayorÃ­a
moda_con_mayoria <- function(x, umbral = 0.05) {
  x <- na.omit(x)
  if (length(x) == 0) return(NA)
  tab <- table(x)
  moda <- names(tab)[which.max(tab)]
  prop <- max(tab) / sum(tab)
  if (prop >= umbral) return(moda) else return(NA)
}

# Aplicar imputaciÃ³n con control de mayorÃ­a
proveedores_ciiu_imputado2 <- proveedores_ciiu_imputado %>%
  mutate(nombre_base = word(MCOD_1, 1, 3)) %>%
  group_by(nombre_base) %>%
  mutate(
    moda_valor = moda_con_mayoria(CIIU_final, umbral = 0.05),
    CIIU_final = if_else(is.na(CIIU_final), moda_valor, CIIU_final)
  ) %>%
  ungroup() %>%
  select(-nombre_base, -moda_valor)

Pero veo que no lo hace como yo quiera, pues en este ejemplo deberÃ­a imputarse el 4661 que es el que mas se repite de los nombres similares del grupo TRAFIGURA, pero esta poniendo un 10 y un NA

MCOD_1	ANTES	CIIU_final
TRAFIGURAÂ ENVIRONMENTALÂ S	NA	NA
TRAFIGURAÂ TRADINGÂ LLC	4669	4669
TRAFIGURAÂ SECURITISATION	NA	10
TRAFIGURAÂ MARITIMEÂ LOGIST	6412	6412
TRAFIGURAÂ PTEÂ LTD	4290	4290
C.I.Â TRAFIGURAÂ PETROLEUM	4661	4661
TRAFIGURAÂ ENERGYÂ COLOMBIA	4661	4661
TRAFIGURAÂ MARKETINGÂ COLOM	4661	4661

como lo resuelvo
