from graphviz import Digraph
from IPython.display import Image, display

# Crear diagrama de flujo
impact_flow = Digraph('Impacto', format='png')
impact_flow.attr(size='12')

# Nodos principales
impact_flow.node('Start', 'Inicio', shape='oval', style='filled', fillcolor='lightgray')

# Pregunta inicial: Disponibilidad de datos históricos
impact_flow.node('D1', '¿Hay datos históricos sobre pérdidas?', shape='diamond', style='filled', fillcolor='lightblue')

# Si no hay datos, aplicar juicio experto
impact_flow.node('J1', 'Aplicar juicio de expertos', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('J2', 'Seleccionar método de juicio experto:\n- Delphi\n- Ponderación\n- Análisis de escenarios', shape='rectangle', style='filled', fillcolor='lightyellow')
impact_flow.node('J3', 'Documentar juicio experto\npara futuras revisiones', shape='rectangle', style='filled', fillcolor='lightcoral')

# Si hay datos, verificar si son suficientes
impact_flow.node('D2', '¿Los datos son suficientes\ny representativos?', shape='diamond', style='filled', fillcolor='lightblue')

# Si los datos no son suficientes, complementar con fuentes externas
impact_flow.node('M0', 'Consultar fuentes externas\no bases de datos del sector', shape='rectangle', style='filled', fillcolor='lightgreen')

# Si los datos son suficientes, modelar distribución de pérdidas
impact_flow.node('M1', 'Recolectar y analizar datos históricos\nde pérdidas', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M2', 'Ajustar diferentes distribuciones estadísticas:\n- Normal\n- Lognormal\n- Pareto\n- Weibull', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M3', 'Determinar la mejor distribución\n(Pruebas de bondad de ajuste):\n- Kolmogorov-Smirnov\n- Chi-cuadrado\n- AIC', shape='rectangle', style='filled', fillcolor='lightyellow')

# Definición de umbrales
impact_flow.node('D3', '¿La distribución es predecible?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('M4', 'Definir percentiles clave\npara umbrales de impacto', shape='rectangle', style='filled', fillcolor='lightyellow')

# Evaluación de eventos extremos
impact_flow.node('D4', '¿Hay eventos extremos (cola larga)?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('M5', 'Aplicar metodología de\nValor en Riesgo (VaR)', shape='rectangle', style='filled', fillcolor='lightgreen')

# Selección de escala
impact_flow.node('D5', '¿La dispersión de los datos es uniforme?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('S1', 'Usar escala lineal', shape='rectangle', style='filled', fillcolor='lightyellow')
impact_flow.node('S2', 'Usar escala logarítmica\n(eventos de alto impacto)', shape='rectangle', style='filled', fillcolor='lightyellow')

# Niveles de impacto
impact_flow.node('N1', 'Definir niveles de impacto (5x5 o 6x6)', shape='rectangle', style='filled', fillcolor='lightgreen')

# Dimensiones de impacto
impact_flow.node('DIM', 'Definir dimensiones de impacto:\n- Financiero\n- Ambiental\n- Operacional\n- Reputacional\n- Seguridad\n- Regulatorio\n- Tecnológico', shape='rectangle', style='filled', fillcolor='lightyellow')

# Fin del proceso
impact_flow.node('End', 'Escala de Impacto Definida', shape='oval', style='filled', fillcolor='lightgray')

# Conexiones principales
impact_flow.edge('Start', 'D1', color='black')
impact_flow.edge('D1', 'D2', label='Sí', color='blue')
impact_flow.edge('D1', 'J1', label='No', color='red')
impact_flow.edge('J1', 'J2', color='black')
impact_flow.edge('J2', 'J3', color='black')
impact_flow.edge('J3', 'N1', color='black')

impact_flow.edge('D2', 'M1', label='Sí', color='blue')
impact_flow.edge('D2', 'M0', label='No', color='red')
impact_flow.edge('M0', 'M1', label='Datos obtenidos', color='blue')
impact_flow.edge('M1', 'M2', color='black')
impact_flow.edge('M2', 'M3', color='black')
impact_flow.edge('M3', 'D3', color='black')

impact_flow.edge('D3', 'M4', label='Sí', color='blue')
impact_flow.edge('D3', 'D4', label='No', color='red')
impact_flow.edge('D4', 'M5', label='Sí', color='red')
impact_flow.edge('D4', 'M4', label='No', color='blue')
impact_flow.edge('M5', 'M4', color='black')

impact_flow.edge('M4', 'D5', color='black')
impact_flow.edge('D5', 'S1', label='Sí', color='blue')
impact_flow.edge('D5', 'S2', label='No', color='red')

impact_flow.edge('S1', 'N1', color='black')
impact_flow.edge('S2', 'N1', color='black')

impact_flow.edge('N1', 'DIM', color='black')
impact_flow.edge('DIM', 'End', color='black')

# Renderizar el diagrama
impact_flow.render('Impacto_Flujo', view=True)
display(Image(filename='Impacto_Flujo.png'))

a partir de este información construí un diagrama de flujo usando python:

	Definición de la Escala de Impacto

El impacto de un riesgo se mide en función de sus consecuencias en una o varias dimensiones clave. Definir la escala de impacto permite cuantificar la severidad de los eventos de riesgo de manera consistente y comparable en toda la organización.

La metodología para definir la escala de impacto debe seguir alguno de los siguientes dos enfoques, dependiendo de la disponibilidad de datos:

	Enfoque basado en datos: Se utiliza cuando se cuenta con información histórica de eventos de riesgo.
	Enfoque basado en juicio experto: Se aplica cuando no hay datos suficientes y se requiere una evaluación cualitativa.

	 Enfoque basado en datos

Cuando se dispone de datos históricos sobre pérdidas o incidentes, se recomienda definir los umbrales de impacto utilizando técnicas estadísticas y actuariales, asegurando una segmentación objetiva.

	Modelación de la Distribución de Pérdidas

Cuando se dispone de datos históricos de pérdidas (eventos materializados asociados al riesgo), se debe modelar su distribución para definir umbrales de impacto. El procedimiento es el siguiente:

	Recolectar datos históricos de eventos de pérdida (ejemplo: pérdidas financieras en USD, incidentes ambientales con costos de remediación, etc.).
	Ajustar diferentes distribuciones a los datos observados: Se deben evaluar distribuciones como:
	Normal: Para datos simétricos con valores de pérdida relativamente homogéneos.
	Lognormal: Para pérdidas con cola derecha (eventos raros de alto impacto).
	Pareto: Para distribuciones con eventos extremos frecuentes.
	Weibull: Para eventos con tasas de ocurrencia crecientes o decrecientes.

	Determinar la mejor distribución mediante pruebas de bondad de ajuste como:
	Kolmogorov-Smirnov
	Chi-cuadrado
	Criterio de Información de Akaike (AIC)

	Calcular los percentiles clave de la distribución para definir umbrales de impacto.

Si la variable X representa la pérdida y se ajusta a una distribución F(X), los umbrales de impacto pueden definirse por:

P_i=F^(-1) (q_i)

Donde:

P_i es el umbral para el nivel 𝑖 de impacto y q_i son percentiles predefinidos (p.ej., 20%, 50%, 80%, 95%).

	Uso del Valor en Riesgo (VaR) para Riesgos Extremos

En el caso que se tengan riesgos extremos, se puede usar la técnica del Valor en Riesgo (VaR), la cual es una métrica útil para definir umbrales de impacto en términos probabilísticos, recomendables para escenarios catastróficos. 

Se calcula como:

〖VaR〗_α=F^(-1) (α)

Donde:

𝛼 es el nivel de confianza (p.ej., 95% o 99%).
F^(-1) (α) es el percentil correspondiente de la distribución de pérdidas.

Si el área de negocio quiere definir un umbral de impacto crítico, puede establecerlo en función del VaR al 99%, es decir, la pérdida máxima esperada con un 99% de confianza.

En caso de que se cuente con simulaciones (Monte Carlo, Bootstrap, etc.) para modelar pérdidas futuras, el VaR se puede estimar sobre la distribución simulada.

 
	 Enfoque Basado en Juicio Experto

Cuando no se dispone de datos históricos, los umbrales de impacto deben definirse mediante metodologías cualitativas estructuradas para minimizar sesgos:

	Método Delphi: Se consulta a expertos en rondas iterativas para alcanzar consenso.
	Ponderación por consenso: Se asignan valores de impacto con base en experiencias previas y mejores prácticas del sector.
	Análisis de escenarios: Se identifican eventos hipotéticos y su impacto estimado.

En estos casos, las definiciones deben ser documentadas y revisadas periódicamente para incorporar datos conforme se generen.


	 Selección de Escalas para Impacto

Una vez definidos los umbrales de impacto, se debe seleccionar el tipo de escala más adecuado. 

Una escala de impacto en una Matriz de Evaluación de Riesgos (RAM) es un sistema que asigna valores a diferentes niveles de impacto de un riesgo, permitiendo su cuantificación y comparación. Estas escalas son esenciales para evaluar y comunicar la severidad de los riesgos de manera estructurada y consistente.

La selección de la escala correcta para medir el impacto depende de la dispersión de los datos:

	Escalas lineales: Se utilizan cuando la variabilidad entre niveles de impacto es homogénea, es decir, para datos con baja dispersión y diferencias proporcionales entre niveles.
	Escalas logarítmicas: Son adecuadas cuando los impactos varían exponencialmente, como en el caso de pérdidas económicas donde las diferencias entre eventos extremos son significativas. Se recomiendan para datos con alta dispersión o eventos extremos con valores significativamente mayores.

En entornos financieros y de riesgos catastróficos, por ejemplo, es preferible usar escalas logarítmicas. Para riesgos operativos con variaciones más uniformes, se recomienda una escala lineal.
Si la relación entre percentiles muestra un comportamiento exponencial, se debe utilizar una escala logarítmica para evitar sesgos en la colorimetría del mapa de calor.

Para decidir qué escala utilizar, se recomienda:
	Analizar la relación entre percentiles y evaluar si el crecimiento es proporcional o exponencial.
	2.	Aplicar escalas logarítmicas en eventos de “cola larga” con impactos extremos.
	3.	Mantener escalas lineales en riesgos con dispersión uniforme.

	 Definición de Niveles de Impacto

La selección de una escala de impacto y probabilidad es un aspecto fundamental en la evaluación de riesgos, ya que permite establecer un marco claro y consistente para la valoración de eventos adversos. En este contexto, se recomienda utilizar una matriz de riesgo de 5x5, es decir, cinco niveles de impacto y cinco niveles de probabilidad.

Para una escala de cinco niveles de impacto, su descripción sería la siguiente:

1. Insignificante: Impacto insignificante, sin afectación real.
2. Menor: Afectación menor, pero manejable internamente.
3. Moderado: Impacto con repercusión relevante pero contenible.
4. Mayor: Consecuencias graves que afectan significativamente.
5. Catastrófico: Impacto crítico que amenaza la estabilidad.

La definición específica de cada nivel dependerá de cada área de negocio, del tipo de riesgo y del sector de la operación.

Si bien la escala de 5x5 es adecuada en la mayoría de los contextos, existen situaciones donde se puede justificar el uso de una escala de 6x6 o incluso mayor, esto si los riesgos tienen una distribución con eventos de baja probabilidad y alto impacto (colas largas), se recomienda el uso de seis niveles de impacto cuando hay riesgos catastróficos o de baja probabilidad y alto impacto o Áreas de negocio con alta sensibilidad al riesgo

En este caso, los niveles de impacto serían los siguientes:

1. Insignificante: Impacto insignificante, sin afectación real.
2. Menor: Afectación menor, pero manejable internamente.
3. Moderado: Impacto con repercusión relevante pero contenible.
4. Alto: Consecuencias graves que afectan significativamente.
5. Muy alto: Impacto crítico que amenaza la estabilidad.
6. Catastrófico: Consecuencias extremas, difícilmente reversibles.


	 Identificación de Dimensiones de Impacto

Cada área de negocio debe identificar las dimensiones relevantes para su evaluación de riesgos, las cuales deben guardar relación con el apalancamiento de sus objetivos y del apetito de riesgo definido. 

Algunos ejemplos de dimensiones de impacto son:

	Económico o Financiero: Pérdidas financieras o sobrecostos, pérdidas económicas en relación con EBITDA o ingresos.
	Ambiental: Daños ecológicos medidos en volumen de contaminantes o efectos adversos en el entorno.
	Operacional: Impacto en la continuidad del negocio, incluyendo disrupciones en procesos internos o clave.
	Reputacional: Pérdida de confianza de los stakeholders o afectación a la imagen de la organización.
	Seguridad y Salud: Consecuencias en términos de lesiones o fatalidades.
	Regulatorio: Incumplimiento de normativas, resultando en multas o sanciones.
	Tecnológico (ciberseguridad, interrupciones IT, etc.).

Cada dimensión debe contar con criterios objetivos de medición definidos por cada área de negocio, basados en su perfil de riesgo.

este es el código

from graphviz import Digraph
from IPython.display import Image, display

# Diagrama de Flujo para la Escala de Impacto
impact_flow = Digraph('Impacto', format='png')
impact_flow.attr(size='10')

# Nodos principales con colores
impact_flow.node('Start', 'Inicio', shape='oval', style='filled', fillcolor='lightgray')
impact_flow.node('D1', '¿Hay datos históricos?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('D2', '¿Los datos son suficientes?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('D3', '¿Los impactos siguen una distribución predecible?', shape='diamond', style='filled', fillcolor='lightblue')
impact_flow.node('M0', 'Consultar fuentes externas', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M1', 'Definir umbrales de impacto con una escala lineal', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M2', 'Evaluar si hay eventos extremos que justifican una escala logarítmica', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M3', 'Modelar distribución de pérdidas', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('M4', 'Definir percentiles y umbrales', shape='rectangle', style='filled', fillcolor='lightyellow')
impact_flow.node('M5', 'Definir umbrales', shape='rectangle', style='filled', fillcolor='lightyellow')
impact_flow.node('J1', 'Aplicar juicio de expertos', shape='rectangle', style='filled', fillcolor='lightgreen')
impact_flow.node('J2', 'Documentar juicio de expertos', shape='rectangle', style='filled', fillcolor='lightcoral')
impact_flow.node('End', 'Escala de Impacto Definida', shape='oval', style='filled', fillcolor='lightgray')

# Conexiones con colores
impact_flow.edge('Start', 'D1', color='black')
impact_flow.edge('D1', 'D2', label='Sí', color='blue')
impact_flow.edge('D1', 'M0', label='No', color='red')
impact_flow.edge('M0', 'D2', label='Sí', color='blue')
impact_flow.edge('D2', 'M3', label='Sí', color='blue')
impact_flow.edge('M3', 'D3', label='Sí', color='blue')
impact_flow.edge('D3', 'M1', label='Sí', color='blue')
impact_flow.edge('D3', 'M2', label='No', color='red')
impact_flow.edge('D2', 'J1', label='No', color='red')
impact_flow.edge('J1', 'J2', color='black')
impact_flow.edge('J2', 'M5', color='black')
impact_flow.edge('M1', 'M4', color='black')
impact_flow.edge('M2', 'M4', color='black')
impact_flow.edge('M4', 'End', color='black')
impact_flow.edge('M5', 'End', color='black')

# Renderizar el diagrama
impact_flow.render('Impacto_Flujo', view=True)
display(Image(filename='Impacto_Flujo.png'))

Pero no está reflejando todo el proceso o caracteristicas que quiero que tenga, debe inluir todo y ser claro en el procedimiento mostrado. Ayudame a que esto se cumpla, mejora el código.
